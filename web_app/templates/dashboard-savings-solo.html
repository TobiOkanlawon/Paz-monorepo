{{define "title"}}Family Vault{{end}} {{define "head"}}
<link href="/static/css/solo-saver.css" rel="stylesheet" />
{{end}} {{define "main"}}
<main>
  <div class="heading-container">
    <div class="heading-container-left">
      <h1>Paz Solo Saver</h1>
      <p>Save money spontaneously with interest of up to 12% per annum.</p>
    </div>
    <div class="heading-container-right">
      <button class="primary" id="withdraw">Withdraw funds</button>
    </div>
  </div>

  <div class="main-content">
    <article class="savings-balance-container">
      <div class="savings-balance-container-left">
        <h2>Paz saver balance</h2>
        <p>&#8358; {{.Balance}}</p>
      </div>
      <div class="savings-balance-container-right">
	{{if .HasPendingPayment}}
	<p>Savings Top-Up Pending</p>
	{{else}}
        <button id="instant-top-up" class="primary">Instant top up</button>
	{{end}}
      </div>
    </article>

    <div class="activity-container">
      <h2>Recent activity</h2>
      <p>No activity</p>
    </div>
  </div>
</main>

<div class="modal-flex-container hidden" id="withdraw-modal">
  <div id="modal-container">
    <article class="modal">
      
    </article>
  </div>
  <div class="modal-overlay"></div>
</div>

<div class="modal-flex-container hidden" id="top-up-modal" role="document">
  <div id="modal-container">
    <article class="modal">
      <div class="modal-heading-container">
        <h2 id="top-up-heading">Top-up your savings</h2>
        <p>Save up the money that you'll regret spending</p>
      </div>

      <form id="savings-form" method="POST">
        <div class="form-control">
          <label for="top-up-amount">Top-up amount*</label>
          <input
            id="top-up-amount"
            name="top-up-amount"
            type="number"
            min="1000"
            required
            placeholder="How much would you like to save?"
          />
          <div class="form-control-error-container"></div>
          <!-- TODO: add regex validation -->
        </div>

        <!-- <div class="form-control"> -->
        <!--   <label for="withdrawal-account" -->
        <!--     >Select account to withdraw from*</label -->
        <!--   > -->
        <!--   <select -->
        <!--     id="withdrawal-account" -->
        <!--     name="withdrawal-account" -->
        <!--     type="number" -->
        <!--   > -->
        <!--     <option value="">Select the account to withdraw from</option> -->
        <!--     {{range .Information.Accounts}} -->
        <!--     <option value="{{.ID}}">{{.Name}}</option> -->
        <!--     {{end}} -->
        <!--   </select> -->
        <!--   <div class="form-control-error-container"></div> -->
        <!--   <\!-- TODO: add regex validation -\-> -->
        <!-- </div> -->

        <button id="process-payment-button" type="submit" class="primary">
          Save
        </button>
      </form>
    </article>
  </div>
  <div class="modal-overlay"></div>
  <script src="https://js.paystack.co/v1/inline.js"></script>
</div>

<script>
  const topUpModal = document.querySelector("#top-up-modal");
  const withdrawModal = document.querySelector("#withdraw-modal");
  const allOverlays = document.querySelectorAll(".modal-overlay");
  const topUpButton = document.getElementById("instant-top-up");
  const withdrawButton = document.getElementById("withdraw");
  const processPaymentButton = document.getElementById("process-payment-button");
  const savingsForm = document.getElementById("savings-form");
  const amount = document.getElementById("top-up-amount");
  const csrfToken = {{.csrfToken}}
  const referenceNumber = {{.ReferenceNumber}}

  const getCookie = function(cookieName) {
      const name = cookieName + "=";
      const cDecoded = decodeURIComponent(document.cookie);
      //to be careful
      const cArr = cDecoded.split('; ');
      let res;
      cArr.forEach(val => {
	  if (val.indexOf(name) === 0) res = val.substring(name.length);
      })
      return res
  }

  const sessionToken = getCookie("session")

  const openTopUpModal = function () {
      topUpModal.classList.remove("hidden");
  };

  const openWithdrawModal = function () {
      withdrawModal.classList.remove("hidden");
  };

  const closeTopUpModal = function () {
      topUpModal.classList.add("hidden");
  };

  const closeWithdrawModal = function () {
      withdrawModal.classList.add("hidden");
  };

  const sendPaymentToBackend = async function (referenceNumber, amount) {
      const data =  {
	  Amount: amount,
	  Account: 0,
	  ReferenceNumber: referenceNumber,
      }
      const url = "/dashboard/savings/solo-saver"
      const response = await fetch(url, {
	  method: "POST",
	  mode: "same-origin",
	  cache: "no-cache",
	  headers: {
	      "Content-Type": "application/json",
	      "X-CSRF-Token": csrfToken,
	      "X-Authorization": `Bearer ${sessionToken}`,
	  },
	  body: JSON.stringify(data),
      })
      
      // TODO: Show the pending savings message
      // we are relaading to show the pending savings message
      // However, this is an inefficient method.
      // The better solution is to send a HTMx response from the sendPaymentToBackend route and move that into the template
      
      window.location.reload();
      // return response.json();
  }

  const openPaystackModal = function (e) {
      e.preventDefault();
      let handler = PaystackPop.setup({
	  key: "{{.PublicKey}}",
	  email: "{{.Information.EmailAddress}}",
	  amount: amount.value * 100,
	  // amount is multiplied by 100 so that it can be represented as kobos
	  ref: referenceNumber,
	  // label: "Optional string that replaces customer email"

	  onClose: function () {
	      // reset the form and close the modal.
	      savingsForm.reset();
	      closeTopUpModal();
	  },

	  callback: function(response){

	      // send a request to the backend containing the
	      // reference and the amount along with a csrf token to
	      // prevent XSS, and the user's session token to be sure
	      // that it's this user that sent the request.

	      sendPaymentToBackend(referenceNumber, amount.value * 100);

	      savingsForm.reset();
	      closeTopUpModal();

	      // TODO: make sure that the request retries on failure
	  } 
      });
      handler.openIframe();
  };

  for (let i = 0; i < allOverlays.length; i++) {
      const overlay = allOverlays[i];
      overlay.addEventListener("click", () => {closeTopUpModal(); closeWithdrawModal();});
  }

  topUpButton.addEventListener("click", openTopUpModal);
  withdrawButton.addEventListener("click", openWithdrawModal);
  processPaymentButton.addEventListener("click", openPaystackModal);
</script>

{{end}}
